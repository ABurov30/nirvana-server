{"version":3,"names":["program","commander","Command","collect","value","previousValue","values","split","push","option","version","usage","parse","process","argv","babelOptions","caller","name","extensions","ignore","only","plugins","presets","configFile","envName","rootMode","babelrc","undefined","key","Object","keys","register","replPlugin","types","t","visitor","VariableDeclaration","path","node","kind","buildCodeFrameError","Program","hasExpressionStatement","bodyPath","get","isExpressionStatement","isExportDeclaration","isImportDeclaration","pushContainer","expressionStatement","identifier","_eval","code","filename","trim","babel","transformSync","concat","vm","runInThisContext","eval","print","global","__filename","__dirname","cwd","module","Module","paths","_nodeModulePaths","exports","require","bind","result","output","inspect","stdout","write","args","length","slice","i","ignoreNext","some","arg","i2","parsedOption","options","find","long","short","optionName","attributeName","parsedArg","requireArgs","isAbsolute","join","execArgv","runMain","replStart","replEval","context","callback","err","e","replServer","repl","start","prompt","input","stdin","useGlobal","preview","NODE_REPL_HISTORY","env","setupHistory"],"sources":["../src/_babel-node.ts"],"sourcesContent":["import commander from \"commander\";\nimport Module from \"module\";\nimport { inspect } from \"util\";\nimport path from \"path\";\nimport repl from \"repl\";\nimport * as babel from \"@babel/core\";\nimport vm from \"vm\";\nimport \"core-js/stable/index\";\nimport \"regenerator-runtime/runtime\";\n// @ts-expect-error @babel/register is a CommonJS module\nimport register from \"@babel/register\";\nimport { fileURLToPath } from \"url\";\nimport { createRequire } from \"module\";\n\nimport type { PluginAPI, PluginObject } from \"@babel/core\";\n\nconst require = createRequire(import.meta.url);\n\nconst program = new commander.Command(\"babel-node\");\n\nfunction collect(value: unknown, previousValue: string[]): Array<string> {\n  // If the user passed the option with no value, like \"babel-node file.js --presets\", do nothing.\n  if (typeof value !== \"string\") return previousValue;\n\n  const values = value.split(\",\");\n\n  if (previousValue) {\n    previousValue.push(...values);\n    return previousValue;\n  }\n  return values;\n}\n\nprogram.option(\"-e, --eval [script]\", \"Evaluate script\");\nprogram.option(\n  \"--no-babelrc\",\n  \"Specify whether or not to use .babelrc and .babelignore files\",\n);\nprogram.option(\"-r, --require [module]\", \"Require module\");\nprogram.option(\"-p, --print [code]\", \"Evaluate script and print result\");\nprogram.option(\n  \"-o, --only [globs]\",\n  \"A comma-separated list of glob patterns to compile\",\n  collect,\n);\nprogram.option(\n  \"-i, --ignore [globs]\",\n  \"A comma-separated list of glob patterns to skip compiling\",\n  collect,\n);\nprogram.option(\n  \"-x, --extensions [extensions]\",\n  \"List of extensions to hook into [.es6,.js,.es,.jsx,.mjs]\",\n  collect,\n);\nprogram.option(\n  \"--config-file [path]\",\n  \"Path to the babel config file to use. Defaults to working directory babel.config.js\",\n);\nprogram.option(\n  \"--env-name [name]\",\n  \"The name of the 'env' to use when loading configs and plugins. \" +\n    \"Defaults to the value of BABEL_ENV, or else NODE_ENV, or else 'development'.\",\n);\nprogram.option(\n  \"--root-mode [mode]\",\n  \"The project-root resolution mode. \" +\n    \"One of 'root' (the default), 'upward', or 'upward-optional'.\",\n);\nprogram.option(\"-w, --plugins [string]\", \"\", collect);\nprogram.option(\"-b, --presets [string]\", \"\", collect);\n\ndeclare const PACKAGE_JSON: { name: string; version: string };\nprogram.version(PACKAGE_JSON.version);\nprogram.usage(\"[options] [ -e script | script.js ] [arguments]\");\nprogram.parse(process.argv);\n\nconst babelOptions = {\n  caller: {\n    name: \"@babel/node\",\n  },\n  extensions: program.extensions,\n  ignore: program.ignore,\n  only: program.only,\n  plugins: program.plugins,\n  presets: program.presets,\n  configFile: program.configFile,\n  envName: program.envName,\n  rootMode: program.rootMode,\n\n  // Commander will default the \"--no-\" arguments to true, but we want to\n  // leave them undefined so that @babel/core can handle the\n  // default-assignment logic on its own.\n  babelrc: program.babelrc === true ? undefined : program.babelrc,\n};\n\nfor (const key of Object.keys(babelOptions) as Array<\n  keyof typeof babelOptions\n>) {\n  if (babelOptions[key] === undefined) {\n    delete babelOptions[key];\n  }\n}\n\nregister(babelOptions);\n\nconst replPlugin = ({ types: t }: PluginAPI): PluginObject => ({\n  visitor: {\n    VariableDeclaration(path) {\n      if (path.node.kind !== \"var\") {\n        throw path.buildCodeFrameError(\n          \"Only `var` variables are supported in the REPL\",\n        );\n      }\n    },\n\n    Program(path) {\n      let hasExpressionStatement: boolean;\n      for (const bodyPath of path.get(\"body\")) {\n        if (bodyPath.isExpressionStatement()) {\n          hasExpressionStatement = true;\n        } else if (\n          bodyPath.isExportDeclaration() ||\n          bodyPath.isImportDeclaration()\n        ) {\n          throw bodyPath.buildCodeFrameError(\n            \"Modules aren't supported in the REPL\",\n          );\n        }\n      }\n      if (hasExpressionStatement) return;\n\n      // If the executed code doesn't evaluate to a value,\n      // prevent implicit strict mode from printing 'use strict'.\n      path.pushContainer(\n        \"body\",\n        t.expressionStatement(t.identifier(\"undefined\")),\n      );\n    },\n  },\n});\n\nconst _eval = function (code: string, filename: string) {\n  code = code.trim();\n  if (!code) return undefined;\n\n  code = babel.transformSync(code, {\n    filename: filename,\n    presets: program.presets,\n    plugins: (program.plugins || []).concat([replPlugin]),\n  }).code;\n\n  return vm.runInThisContext(code, {\n    filename: filename,\n  });\n};\n\nif (program.eval || program.print) {\n  let code = program.eval;\n  if (!code || code === true) code = program.print;\n\n  global.__filename = \"[eval]\";\n  global.__dirname = process.cwd();\n\n  const module = new Module(global.__filename);\n  module.filename = global.__filename;\n  // @ts-expect-error todo(flow->ts)\n  module.paths = Module._nodeModulePaths(global.__dirname);\n\n  global.exports = module.exports;\n  global.module = module;\n  global.require = module.require.bind(module);\n\n  const result = _eval(code, global.__filename);\n  if (program.print) {\n    const output = typeof result === \"string\" ? result : inspect(result);\n    process.stdout.write(output + \"\\n\");\n  }\n} else {\n  if (program.args.length) {\n    // slice all arguments up to the first filename since they're babel args that we handle\n    let args = process.argv.slice(2);\n\n    let i = 0;\n    let ignoreNext = false;\n    args.some(function (arg, i2) {\n      if (ignoreNext) {\n        ignoreNext = false;\n        return;\n      }\n\n      if (arg[0] === \"-\") {\n        const parsedOption = program.options.find((option: any) => {\n          return option.long === arg || option.short === arg;\n        });\n        if (parsedOption === undefined) {\n          return;\n        }\n        const optionName = parsedOption.attributeName();\n        const parsedArg = program[optionName];\n        if (optionName === \"require\" || (parsedArg && parsedArg !== true)) {\n          ignoreNext = true;\n        }\n      } else {\n        i = i2;\n        return true;\n      }\n    });\n    args = args.slice(i);\n\n    requireArgs();\n\n    // make the filename absolute\n    const filename = args[0];\n    if (!path.isAbsolute(filename)) {\n      args[0] = path.join(process.cwd(), filename);\n    }\n\n    // add back on node and concat the sliced args\n    process.argv = [\"node\", ...args];\n    process.execArgv.push(fileURLToPath(import.meta.url));\n\n    Module.runMain();\n  } else {\n    requireArgs();\n    replStart();\n  }\n}\n\n// We have to handle require ourselves, as we want to require it in the context of babel-register\nfunction requireArgs() {\n  if (program.require) {\n    require(require.resolve(program.require, {\n      paths: [process.cwd()],\n    }));\n  }\n}\nfunction replEval(\n  this: repl.REPLServer,\n  code: string,\n  context: vm.Context,\n  filename: string,\n  callback: (err: Error | null, result: any) => void,\n) {\n  let err;\n  let result;\n\n  try {\n    if (code[0] === \"(\" && code[code.length - 1] === \")\") {\n      code = code.slice(1, -1); // remove \"(\" and \")\"\n    }\n\n    result = _eval(code, filename);\n  } catch (e) {\n    err = e;\n  }\n\n  callback(err, result);\n}\n\nfunction replStart() {\n  const replServer = repl.start({\n    prompt: \"babel > \",\n    input: process.stdin,\n    output: process.stdout,\n    eval: replEval,\n    useGlobal: true,\n    preview: true,\n  });\n  const NODE_REPL_HISTORY = process.env.NODE_REPL_HISTORY;\n  if (process.env.BABEL_8_BREAKING) {\n    replServer.setupHistory(NODE_REPL_HISTORY, () => {});\n  } else {\n    replServer.setupHistory?.(NODE_REPL_HISTORY, () => {});\n  }\n}\n"],"mappings":"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"}